(()=>{"use strict";class e{data=[];render(){this.view=document.createElement("div"),this.view.classList.add("mr-4");const e=document.createElement("label");e.classList.add("label"),e.innerText=`Загрузка разнарядки${this.label}`,this.input=document.createElement("input"),this.input.classList.add("button"),this.input.type="file",this.lastDate=document.createElement("div"),this.lastDate.classList.add("is-size-7","has-text-weight-bold"),this.lastDate.innerHTML=`Данные загружены: <span class="has-text-success">${this.date}</span>`,this.input.addEventListener("change",this.handleFile.bind(this),!1),this.notification=document.createElement("div"),this.notification.classList.add("notification","is-primary","is-light","is-hidden"),this.notification.innerText="Данные загружены",this.view.appendChild(e),this.view.appendChild(this.input),this.view.appendChild(this.lastDate),this.view.appendChild(this.notification)}save(){let e={fileName:this.unit.fileName,labelName:this.unit.labelName,data:this.data};this.app.request("save",e).then((e=>{e>0&&(this.notification.classList.remove("is-hidden"),this.unit.init(),setTimeout((()=>{this.notification.classList.add("is-hidden"),this.input.value=""}),500))}))}updateDate(e){this.date=e,this.lastDate.innerHTML=`Данные загружены: <span class="has-text-success">${this.date}</span>`}injection(e,t){this[e]=t}constructor(e=""){this.date="никогда",this.label=e?` (${e})`:"",this.render()}}class t extends e{parse(e){let t=!1,a=e.split("\r\n"),i={title:"Аргументы и факты",data:[],totalCount:0};for(let e of a){let a=e.replace(/(\d+),(\d+)/g,"$1$2").split(";");if(t&&"Киров_Типография"!=a[0]){let e=parseInt(a[3])+parseInt(a[4]);i.data.push({title:a[0],value:e}),e&&(i.totalCount+=e)}0===a[0].search("---")&&(t=!t)}i.data.pop(),this.data=[i],this.save()}handleFile(e){this.labelData=[];let t=e.target.files[0],a=new FileReader;a.addEventListener("load",(e=>{let t=e.target.result.replaceAll(/( ){3,}/g,";");this.parse(t)})),a.readAsText(t,"CP1251")}}class a{template='\n        <div class="is-hidden" id="main-wrapper">\n        <div class="title is-size-5 mt-6">Печать ярлыков</div>\n\n        <form class="form mt-4" id="label-form">\n            <div class="field is-grouped">\n                <div class="field mr-4">\n                    <label class="label">Издание</label>\n                    <div class="select">\n                        <select id="select-title" name="title"></select>\n                    </div>\n                    <p class="help is-danger is-hidden" id="title-warning">Заполните поле</p>\n                </div>\n                <div class="field mr-4">\n                    <label class="label">Печатать</label>\n                    <div class="control">\n                        <label class="radio">\n                            <input type="radio" name="printall" value="full" checked>\n                            Всё\n                        </label>\n                        <label class="radio">\n                            <input type="radio" name="printall" value="byparts">\n                            Частями\n                        </label>\n                    </div>\n                </div>\n                <div class="field mr-4">\n                    <label class="label">Часть</label>\n                    <div class="select">\n                        <select id="select-part" name="part" disabled></select>\n                    </div>\n                    <p class="help is-danger is-hidden" id="part-warning">Заполните поле</p>\n                </div>\n            </div>\n            <div class="field is-grouped">\n                <div class="field mr-4">\n                    <label class="label">Номер</label>\n                    <input name="num" class="input" type="text" placeholder="Номер">\n                    <p class="help is-danger is-hidden" id="num-warning">Заполните поле</p>\n                </div>\n                <div class="field mr-4">\n                    <label class="label">Дата выхода</label>\n                    <input name="date" class="input" type="date" placeholder="Дата">\n                    <p class="help is-danger is-hidden" id="date-warning">Заполните поле</p>\n                </div>\n                <div class="field mr-4">\n                    <label class="label">Тираж</label>\n                    <input name="count" class="input" type="number" placeholder="Тираж">\n                    <p class="help is-danger is-hidden" id="count-warning">Заполните поле</p>\n                </div>\n                <div class="field mr-4">\n                    <label class="label">Номер заказа</label>\n                    <input name="ordernum" class="input" type="string" placeholder="Номер заказа">\n                    <p class="help is-danger is-hidden" id="ordernum-warning">Заполните поле</p>\n                </div>\n            </div>\n            <div class="field is-grouped">\n                <div class="field mr-4">\n                    <label class="label">Формат</label>\n                    <div class="control">\n                        <label class="radio">\n                            <input type="radio" name="size" value="A4">\n                            А4\n                        </label>\n                        <label class="radio">\n                            <input type="radio" name="size" value="A6">\n                            А6\n                        </label>\n                    </div>\n                    <p class="help is-danger is-hidden" id="size-warning">Заполните поле</p>\n                </div>\n                <div class="field mr-4">\n                    <label class="label">Количество в пачке</label>\n                    <input name="countpack" class="input" type="number" placeholder="В пачке" value="200" step=50>\n                    <p class="help is-danger is-hidden" id="count-pack-warning">Заполните поле</p>\n                </div>\n            </div>\n            <button type="submit" class="button is-primary" id="button-print">Печатать</button>        \n        </form>\n        </div>\n     ';async requestRenderLabels(){const e={data:this.printParams},t=await fetch("renderLabels.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return await t.json()}validate(e){let t=!0;for(let e of this.view.querySelectorAll(".is-danger"))e.classList.add("is-hidden");return""==e.title.value&&(this.view.querySelector("#title-warning").classList.remove("is-hidden"),t=!1),""==e.num.value&&(this.view.querySelector("#num-warning").classList.remove("is-hidden"),t=!1),""==e.ordernum.value&&(this.view.querySelector("#ordernum-warning").classList.remove("is-hidden"),t=!1),""==e.date.value&&(this.view.querySelector("#date-warning").classList.remove("is-hidden"),t=!1),"full"==e.printall.value&&""==e.count.value&&(this.view.querySelector("#count-warning").classList.remove("is-hidden"),t=!1),""!=e.countpack.value&&0!=e.countpack.value||(this.view.querySelector("#count-pack-warning").classList.remove("is-hidden"),t=!1),""==e.size.value&&(this.view.querySelector("#size-warning").classList.remove("is-hidden"),t=!1),"byparts"==e.printall.value&&""==e.part.value&&(this.view.querySelector("#part-warning").classList.remove("is-hidden"),t=!1),t}formatDate(e){let t=e.split("-");return`${t[2]}.${t[1]}.${t[0]}`}renderTitleSelect(){if(this.labelData.length>1){this.selectTitle.innerHTML="<option></option>";for(let e in this.labelData)this.selectTitle.innerHTML+=`<option value=${e}>${this.labelData[e].title}</option>`}else this.selectTitle.innerHTML=`<option value=0>${this.labelData[0].title}</option>`,this.renderPartSelect(this.labelData[0]),this.labelData[0].totalCount&&(this.labelForm.elements.count.value=this.labelData[0].totalCount)}renderPartSelect(e){this.selectPart.innerHTML="<option></option>";for(let t in e.data){let a=e.data[t].title.length<50?e.data[t].title:e.data[t].title.substring(0,50)+"...";this.selectPart.innerHTML+=`<option value=${t}>${e.data[t].title?a:"--Пустой--"}</option>`}}update(e){this.date=e.date,this.labelData=e.data,this.renderTitleSelect()}show(){this.view.querySelector("#main-wrapper").classList.remove("is-hidden")}print(e){const t=window.open("","","left=50,top=50,width=1920,height=1080,toolbar=0,scrollbars=1,status=0");t.document.write(e),t.document.close(),t.focus(),setTimeout((()=>{t.print(),t.close()}),3e3)}generateLabels(){console.log(this.printParams),this.requestRenderLabels().then((e=>{this.print(e)}))}injection(e,t){this[e]=t}setPrintMode(e){switch(e){case"byparts":this.selectPart.removeAttribute("disabled"),this.view.querySelector('[name="count"]').setAttribute("disabled","disabled"),this.fullFlag=!1;break;case"full":this.printPart={},this.selectPart.setAttribute("disabled","disabled"),this.view.querySelector('[name="count"]').removeAttribute("disabled"),this.fullFlag=!0}}setPrintPart(e){this.printData=e}constructor(){this.view=document.createElement("div"),this.view.innerHTML=this.template,this.fullFlag=!0,this.selectTitle=this.view.querySelector("#select-title"),this.selectPart=this.view.querySelector("#select-part"),this.btnPrint=this.view.querySelector("#button-print"),this.labelForm=this.view.querySelector("#label-form"),this.printAll=this.view.querySelectorAll('[name="printall"]'),this.printAll.forEach((e=>{e.addEventListener("click",(e=>{this.setPrintMode(e.target.value)}))})),this.selectTitle.addEventListener("change",(e=>{this.renderPartSelect(this.labelData[e.target.value])})),this.selectPart.addEventListener("change",(e=>{this.setPrintPart(this.labelData[this.labelForm.elements.title.value].data[e.target.value])})),this.btnPrint.addEventListener("click",(e=>{e.preventDefault(),this.validate(this.labelForm.elements)&&(this.printParams={title:this.labelData[this.labelForm.elements.title.value].title,labelName:this.unit.labelName,num:this.labelForm.elements.num.value,orderNum:this.labelForm.elements.ordernum.value,date:this.formatDate(this.labelForm.elements.date.value),totalCount:this.fullFlag?this.labelForm.elements.count.value:this.printData.value,maxItemsInPack:this.labelForm.elements.countpack.value,size:this.labelForm.elements.size.value,data:this.fullFlag?this.labelData[this.labelForm.elements.title.value].data:[this.printData]},this.generateLabels())}))}}class i{template='\n        <div id="title" class="title is-2"></div>\n        <div id="loadersWrapper" class="field is-grouped"></div>\n        <div id="printerWrapper" class="mt-4"></div>        \n    ';createTab(){this.tab=document.createElement("li"),this.tab.innerHTML=`<a>${this.title}</a>`,this.tab.addEventListener("click",(()=>{for(let e of document.querySelector("#tabs").querySelectorAll("li"))e.classList.remove("is-active");this.tab.classList.add("is-active"),this.app.mainWrapper.innerHTML="",this.app.mainWrapper.appendChild(this.view),this.init()}))}init(){this.app.request("load",{fileName:this.fileName}).then((e=>{if(this.data=e,this.data.date){this.printer.update(this.data);for(let e of this.loaders)e.updateDate(this.data.date);this.printer.show()}}))}render(){this.view.querySelector("#title").innerText=this.title;for(let e of this.loaders)this.view.querySelector("#loadersWrapper").appendChild(e.view);this.view.querySelector("#printerWrapper").appendChild(this.printer.view)}constructor(e,t){if(this.app=e,this.title=t.title,this.fileName=t.filename,this.labelName=t.labelName,this.loaders=[],t.loaders)for(let e of t.loaders)e.injection("app",this.app),e.injection("unit",this),this.loaders.push(e);t.printer&&(this.printer=t.printer,this.printer.injection("app",this.app),this.printer.injection("unit",this)),this.view=document.createElement("div"),this.view.innerHTML=this.template,this.createTab(),this.render()}}const l=document.querySelector("#app"),s=[{title:"Районки",filename:"VID",labelName:"Вятский издательский дом, КОГАУ",loaders:[new class extends e{separatedData=[];decChar(e){return String.fromCharCode(e.charCodeAt(0)-1)}getColumn(e,t,a,i){let l=t[0],s=this.decChar(l);for(let n=+t.substring(1)+1;n<=a;n++)e[`${l}${n}`]&&"Итого:"!=e[`${s}${n}`]&&i.push({title:e[`${s}${n}`],value:parseInt(e[`${l}${n}`])})}compileData(e){for(let t of e){let e={title:t.title,data:[]},a=t.data;for(let i in a)"Экз."==a[i]&&this.getColumn(a,i,t.lastIndex,e.data);this.data.push(e)}this.save()}separateData(e){for(let t in e){let a=+t.substring(1),i=this.separatedData.filter((e=>a>e.firstIndex&&a<e.lastIndex))[0];i&&(i.data[t]=e[t])}this.compileData(this.separatedData)}createSegments(e){for(let t in e)e[t].match(/П[0-9]+/)&&(this.separatedData.length>0&&(this.separatedData[this.separatedData.length-1].lastIndex=t.substring(1)-1),this.separatedData.push({firstIndex:+t.substring(1),title:e[t].replace(/П[0-9]+/,"").trim(),data:{}}));this.separatedData[this.separatedData.length-1].lastIndex=1e3,this.separateData(e)}parse(e){let t={};for(let a in e)"!"!=a[0]&&(t[a]=e[a].w.trim());this.createSegments(t)}getFile(e){console.log(e);let t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"});this.parse(a.Sheets["Лист1"])}handleFile(e){this.labelData=[];let t=e.target.files[0],a=new FileReader;a.addEventListener("load",(e=>{let t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"});this.parse(a.Sheets["Лист1"])})),a.readAsArrayBuffer(t)}}],printer:new a},{title:"АиФ-Киров",filename:"aifkirov",labelName:"Аргументы и факты, АО",loaders:[new t,new class extends e{separatedData=[];labelData=[];parse(e){let t={};for(let a in e)"!"!=a[0]&&"e"!=e[a].t&&(t[a]=e[a].w.trim());let a=this.unit.data;for(let e in t)if(0===t[e].indexOf("Пятерочки_Киров №")&&!t[e.replace("A","C")]){let i=e.replace("A","D"),l={};l.title=t[e],l.value=parseInt(t[i]);let s=a.data[0].data.find((e=>e.title==l.title));s?(a.data[0].totalCount=a.data[0].totalCount-s.value-parseInt(l.value),s.value=l.value):(a.data[0].totalCount+=parseInt(l.value),a.data[0].data.push(l))}this.data=a.data,this.save()}handleFile(e){this.labelData=[];let t=e.target.files[0],a=new FileReader;a.addEventListener("load",(e=>{let t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"});this.parse(a.Sheets[Object.keys(a.Sheets)[0]])})),a.readAsArrayBuffer(t)}}("Пятёрочки")],printer:new a},{title:"АиФ-Киров (Коми)",filename:"aifkirovkomi",labelName:"Аргументы и факты, АО",loaders:[new t],printer:new a},{title:"Российская газета",filename:"RG",labelName:'АО "Издательство "Российская газета"',loaders:[new class extends e{separatedData=[];labelData=[];parse(e){let t={};for(let a in e)"!"!=a[0]&&(t[a]=e[a].w.trim());let a={title:'Издание 32185 "Российская газета" Неделя',data:[],totalCount:0};for(let e in t)if("A"==e[0]){let i={};i.title=t[e];let l=e.replace("A","B");i.value=parseInt(t[l]),a.totalCount+=i.value,a.data.push(i)}a.totalCount=a.totalCount/2,this.data=[a],this.save()}handleFile(e){this.labelData=[];let t=e.target.files[0],a=new FileReader;a.addEventListener("load",(e=>{let t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"});this.parse(a.Sheets["Лист1"])})),a.readAsArrayBuffer(t)}}],printer:new a},{title:"Кировская правда",filename:"KirPravda",labelName:"Вятский издательский дом, КОГАУ",loaders:[new class extends e{separatedData=[];labelData=[];parse(e){let t={},a=!1;for(let a in e)"!"!=a[0]&&(t[a]=e[a].w.trim());console.log(t);let i={title:"Кировская правда",data:[],totalCount:0};for(let e in t){if("A"==e[0]&&a&&"ИТОГО:"!=t[e]){let a={};a.title=t[e];let l=e.replace("A","B");a.value=parseInt(t[l]),i.totalCount+=a.value,i.data.push(a)}"Упаковка тиража:"==t[e]&&(a=!0)}i.totalCount=i.totalCount,this.data=[i],console.log(this.data),this.save()}handleFile(e){this.labelData=[];let t=e.target.files[0],a=new FileReader;a.addEventListener("load",(e=>{let t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"});this.parse(a.Sheets[Object.keys(a.Sheets)[0]])})),a.readAsArrayBuffer(t)}}],printer:new a}];let n=new class{units=[];template='\n        <div class="tabs is-boxed">\n            <ul id=\'tabs\'></ul>\n        </div>\n        <div id="mainWrapper"></div>\n    ';addUnit(e){this.units.push(e),this.tabs.appendChild(e.tab)}async request(e,t=[]){const a={method:e,params:t},i=await fetch("back.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await i.json()}constructor(){this.view=document.createElement("div"),this.view.classList.add("box"),this.view.innerHTML=this.template,this.tabs=this.view.querySelector("#tabs"),this.mainWrapper=this.view.querySelector("#mainWrapper")}};l.appendChild(n.view);for(let e of s)n.addUnit(new i(n,e))})();